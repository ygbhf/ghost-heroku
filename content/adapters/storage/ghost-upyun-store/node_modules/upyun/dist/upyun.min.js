/**
  * UPYUN js-sdk 3.3.4
  * (c) 2018
  * @license MIT
  */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("axios")):"function"==typeof define&&define.amd?define(["axios"],t):e.upyun=t(e.axios)}(this,function(e){"use strict";function t(e,t,r){return new Promise(function(n,o){var i=e.slice||e.mozSlice||e.webkitSlice;return i?n(i.call(e,t,r)):o(new Error("not support File type!"))})}function r(t,r,n){var o=n.authorization,i=n.policy,u=new FormData;return u.append("authorization",o),u.append("policy",i),"string"==typeof r&&(r=new Blob([r],{type:"text/plain"})),u.append("file",r),e.post(t,u).then(function(e){var t=e.status,r=e.data;return 200===t&&Promise.resolve(r)})}function n(e,t,r,n){function o(e,t,r,n){return e<20?t&r|~t&n:e<40?t^r^n:e<60?t&r|t&n|r&n:t^r^n}function i(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function u(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function a(e,t){return e<<t|e>>>32-t}function s(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var r=[80],n=1732584193,s=-271733879,c=-1732584194,l=271733878,f=-1009589776,h=0;h<e.length;h+=16){for(var d=n,p=s,v=c,y=l,g=f,m=0;m<80;m++){r[m]=m<16?e[h+m]:a(r[m-3]^r[m-8]^r[m-14]^r[m-16],1);var b=u(u(a(n,5),o(m,s,c,l)),u(u(f,r[m]),i(m)));f=l,l=c,c=a(s,30),s=n,n=b}n=u(n,d),s=u(s,p),c=u(c,v),l=u(l,y),f=u(f,g)}return[n,s,c,l,f]}function c(e){for(var t=[],r=(1<<n)-1,o=0;o<e.length*n;o+=n)t[o>>5]|=(e.charCodeAt(o/8)&r)<<32-n-o%32;return t}function l(e,t){var r=c(e);r.length>16&&(r=s(r,e.length*n));for(var o=[16],i=[16],u=0;u<16;u++)o[u]=909522486^r[u],i[u]=1549556828^r[u];var a=s(o.concat(c(t)),512+t.length*n);return s(i.concat(a),672)}function f(e){for(var t="",n=0;n<4*e.length;n+=3)for(var o=(e[n>>2]>>8*(3-n%4)&255)<<16|(e[n+1>>2]>>8*(3-(n+1)%4)&255)<<8|e[n+2>>2]>>8*(3-(n+2)%4)&255,i=0;i<4;i++)8*n+6*i>32*e.length?t+=r:t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(o>>6*(3-i)&63);return t}return r||(r="="),n||(n=8),function(e,t){return f(l(e,t))}(e,t)}function o(e,t){return t={exports:{}},e(t,t.exports),t.exports}function i(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}function u(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&i(e.slice(0,0))}function a(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=(new Date).toGMTString();return{Authorization:s(e,{method:t,path:r="/"+e.serviceName+r,date:o,contentMd5:n}),"X-Date":o}}function s(e,t){var r=t.method,n=t.path,o=[r,encodeURI(n)];["date","policy","contentMd5"].forEach(function(e){t[e]&&o.push(t[e])});var i=g(e.password,o.join("&"));return"UPYUN "+e.operatorName+":"+i}function c(e,t){if(t.service=e.serviceName,void 0===t["save-key"])throw new Error("upyun - calclate body sign need save-key");void 0===t.expiration&&(t.expiration=parseInt(new Date/1e3+1800,10));var r=b.encode(JSON.stringify(t));return{policy:r,authorization:s(e,{method:"POST",path:"/"+e.serviceName,policy:r})}}function l(e,t){var r=(new Date).toGMTString(),n=t.join("\n"),o=P(n+"&"+e.serviceName+"&"+r+"&"+e.password);return{Authorization:"UpYun "+e.serviceName+":"+e.operatorName+":"+o,Date:r,"User-Agent":"Js-Sdk/"+w.version}}function f(e){return 0===e.indexOf("x-upyun-meta-")}function h(e,t,r){var n=j.getHeaderSign(e,t,r);return Promise.resolve(n)}e="default"in e?e.default:e;var d="undefined"!=typeof window&&("undefined"==typeof process||"browser"===process.title),p=e.defaults.adapter;e.defaults.adapter=function(){return d?p:require("axios/lib/adapters/http")}();var v=function(t,r,n){var o=e.create({baseURL:t+"/"+r.serviceName,maxRedirects:0});return o.interceptors.request.use(function(e){var t=e.method.toUpperCase(),o=e.url.substring(e.baseURL.length);return e.url=encodeURI(e.url),n(r,t,o).then(function(t){return e.headers.common=t,Promise.resolve(e)})},function(e){throw new Error("upyun - request failed: "+e.message)}),o.interceptors.response.use(function(e){return e},function(e){var t=e.response;if(void 0===t)throw e;if(404!==t.status)throw new Error("upyun - response error: "+e.message);return t}),o},y={readBlockAsync:t},g=n,m="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},b=o(function(e,t){!function(r){var n=t,o=e&&e.exports==n&&e,i="object"==typeof m&&m;i.global!==i&&i.window!==i||(r=i);var u=function(e){this.message=e};(u.prototype=new Error).name="InvalidCharacterError";var a=function(e){throw new u(e)},s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c=/[\t\n\f\r ]/g,l={encode:function(e){e=String(e),/[^\0-\xFF]/.test(e)&&a("The string to be encoded contains characters outside of the Latin1 range.");for(var t,r=e.length%3,n="",o=-1,i=e.length-r;++o<i;)t=(e.charCodeAt(o)<<16)+(e.charCodeAt(++o)<<8)+e.charCodeAt(++o),n+=s.charAt(t>>18&63)+s.charAt(t>>12&63)+s.charAt(t>>6&63)+s.charAt(63&t);return 2==r?(t=(e.charCodeAt(o)<<8)+e.charCodeAt(++o),n+=s.charAt(t>>10)+s.charAt(t>>4&63)+s.charAt(t<<2&63)+"="):1==r&&(t=e.charCodeAt(o),n+=s.charAt(t>>2)+s.charAt(t<<4&63)+"=="),n},decode:function(e){var t=(e=String(e).replace(c,"")).length;t%4==0&&(t=(e=e.replace(/==?$/,"")).length),(t%4==1||/[^+a-zA-Z0-9/]/.test(e))&&a("Invalid character: the string to be decoded is not correctly encoded.");for(var r,n,o=0,i="",u=-1;++u<t;)n=s.indexOf(e.charAt(u)),r=o%4?64*r+n:n,o++%4&&(i+=String.fromCharCode(255&r>>(-2*o&6)));return i},version:"0.1.0"};if(n&&!n.nodeType)if(o)o.exports=l;else for(var f in l)l.hasOwnProperty(f)&&(n[f]=l[f]);else r.base64=l}(m)}),w={name:"upyun",version:"3.3.3",description:"UPYUN js sdk",main:"dist/upyun.common.js",module:"dist/upyun.esm.js",scripts:{build:"node build/build.js",test:"npm run test:server && npm run test:client","test:client":"karma start tests/karma.conf.js","test:server":"mocha --compilers js:babel-register tests/server/*"},repository:{type:"git",url:"git@github.com:upyun/node-sdk.git"},keywords:["upyun","js","nodejs","sdk","cdn","cloud","storage"],author:"Leigh",license:"MIT",bugs:{url:"https://github.com/upyun/node-sdk/issues"},homepage:"https://github.com/upyun/node-sdk",contributors:[{name:"yejingx",email:"yejingx@gmail.com"},{name:"Leigh",email:"i@zhuli.me"},{name:"kaidiren",email:"kaidiren@gmail.com"},{name:"Gaara",email:"sabakugaara@users.noreply.github.com"}],devDependencies:{"babel-cli":"^6.24.1","babel-loader":"^7.0.0","babel-plugin-external-helpers":"^6.22.0","babel-plugin-transform-runtime":"^6.23.0","babel-preset-env":"^1.4.0","babel-register":"^6.24.1",chai:"^3.5.0",istanbul:"^0.4.3",karma:"^1.7.0","karma-chrome-launcher":"^2.1.1","karma-mocha":"^1.3.0","karma-sourcemap-loader":"^0.3.7","karma-webpack":"^2.0.3",mocha:"^3.4.1",rollup:"^0.41.6","rollup-plugin-alias":"^1.3.1","rollup-plugin-babel":"^2.7.1","rollup-plugin-commonjs":"^8.0.2","rollup-plugin-json":"^2.1.1","rollup-plugin-node-resolve":"^3.0.0",should:"^9.0.2","uglify-js":"^3.0.11",webpack:"^2.5.1"},dependencies:{axios:"^0.16.1","base-64":"^0.1.0","form-data":"^2.1.4",hmacsha1:"^1.0.0",md5:"^2.2.1","mime-types":"^2.1.15"},browser:{"./upyun/utils.js":"./upyun/browser-utils.js","./upyun/form-upload.js":"./upyun/browser-form-upload.js"}},x=o(function(e){!function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&r.rotl(e,8)|4278255360&r.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=r.endian(e[t]);return e},randomBytes:function(e){for(var t=[];e>0;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],r=0,n=0;r<e.length;r++,n+=8)t[n>>>5]|=e[r]<<24-n%32;return t},wordsToBytes:function(e){for(var t=[],r=0;r<32*e.length;r+=8)t.push(e[r>>>5]>>>24-r%32&255);return t},bytesToHex:function(e){for(var t=[],r=0;r<e.length;r++)t.push((e[r]>>>4).toString(16)),t.push((15&e[r]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],r=0;r<e.length;r+=2)t.push(parseInt(e.substr(r,2),16));return t},bytesToBase64:function(e){for(var r=[],n=0;n<e.length;n+=3)for(var o=e[n]<<16|e[n+1]<<8|e[n+2],i=0;i<4;i++)8*n+6*i<=8*e.length?r.push(t.charAt(o>>>6*(3-i)&63)):r.push("=");return r.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var r=[],n=0,o=0;n<e.length;o=++n%4)0!=o&&r.push((t.indexOf(e.charAt(n-1))&Math.pow(2,-2*o+8)-1)<<2*o|t.indexOf(e.charAt(n))>>>6-2*o);return r}};e.exports=r}()}),k={utf8:{stringToBytes:function(e){return k.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(k.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],r=0;r<e.length;r++)t.push(255&e.charCodeAt(r));return t},bytesToString:function(e){for(var t=[],r=0;r<e.length;r++)t.push(String.fromCharCode(e[r]));return t.join("")}}},A=k,S=function(e){return null!=e&&(i(e)||u(e)||!!e._isBuffer)},P=o(function(e){!function(){var t=x,r=A.utf8,n=S,o=A.bin,i=function(e,u){e.constructor==String?e=u&&"binary"===u.encoding?o.stringToBytes(e):r.stringToBytes(e):n(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||(e=e.toString());for(var a=t.bytesToWords(e),s=8*e.length,c=1732584193,l=-271733879,f=-1732584194,h=271733878,d=0;d<a.length;d++)a[d]=16711935&(a[d]<<8|a[d]>>>24)|4278255360&(a[d]<<24|a[d]>>>8);a[s>>>5]|=128<<s%32,a[14+(s+64>>>9<<4)]=s;for(var p=i._ff,v=i._gg,y=i._hh,g=i._ii,d=0;d<a.length;d+=16){var m=c,b=l,w=f,x=h;l=g(l=g(l=g(l=g(l=y(l=y(l=y(l=y(l=v(l=v(l=v(l=v(l=p(l=p(l=p(l=p(l,f=p(f,h=p(h,c=p(c,l,f,h,a[d+0],7,-680876936),l,f,a[d+1],12,-389564586),c,l,a[d+2],17,606105819),h,c,a[d+3],22,-1044525330),f=p(f,h=p(h,c=p(c,l,f,h,a[d+4],7,-176418897),l,f,a[d+5],12,1200080426),c,l,a[d+6],17,-1473231341),h,c,a[d+7],22,-45705983),f=p(f,h=p(h,c=p(c,l,f,h,a[d+8],7,1770035416),l,f,a[d+9],12,-1958414417),c,l,a[d+10],17,-42063),h,c,a[d+11],22,-1990404162),f=p(f,h=p(h,c=p(c,l,f,h,a[d+12],7,1804603682),l,f,a[d+13],12,-40341101),c,l,a[d+14],17,-1502002290),h,c,a[d+15],22,1236535329),f=v(f,h=v(h,c=v(c,l,f,h,a[d+1],5,-165796510),l,f,a[d+6],9,-1069501632),c,l,a[d+11],14,643717713),h,c,a[d+0],20,-373897302),f=v(f,h=v(h,c=v(c,l,f,h,a[d+5],5,-701558691),l,f,a[d+10],9,38016083),c,l,a[d+15],14,-660478335),h,c,a[d+4],20,-405537848),f=v(f,h=v(h,c=v(c,l,f,h,a[d+9],5,568446438),l,f,a[d+14],9,-1019803690),c,l,a[d+3],14,-187363961),h,c,a[d+8],20,1163531501),f=v(f,h=v(h,c=v(c,l,f,h,a[d+13],5,-1444681467),l,f,a[d+2],9,-51403784),c,l,a[d+7],14,1735328473),h,c,a[d+12],20,-1926607734),f=y(f,h=y(h,c=y(c,l,f,h,a[d+5],4,-378558),l,f,a[d+8],11,-2022574463),c,l,a[d+11],16,1839030562),h,c,a[d+14],23,-35309556),f=y(f,h=y(h,c=y(c,l,f,h,a[d+1],4,-1530992060),l,f,a[d+4],11,1272893353),c,l,a[d+7],16,-155497632),h,c,a[d+10],23,-1094730640),f=y(f,h=y(h,c=y(c,l,f,h,a[d+13],4,681279174),l,f,a[d+0],11,-358537222),c,l,a[d+3],16,-722521979),h,c,a[d+6],23,76029189),f=y(f,h=y(h,c=y(c,l,f,h,a[d+9],4,-640364487),l,f,a[d+12],11,-421815835),c,l,a[d+15],16,530742520),h,c,a[d+2],23,-995338651),f=g(f,h=g(h,c=g(c,l,f,h,a[d+0],6,-198630844),l,f,a[d+7],10,1126891415),c,l,a[d+14],15,-1416354905),h,c,a[d+5],21,-57434055),f=g(f,h=g(h,c=g(c,l,f,h,a[d+12],6,1700485571),l,f,a[d+3],10,-1894986606),c,l,a[d+10],15,-1051523),h,c,a[d+1],21,-2054922799),f=g(f,h=g(h,c=g(c,l,f,h,a[d+8],6,1873313359),l,f,a[d+15],10,-30611744),c,l,a[d+6],15,-1560198380),h,c,a[d+13],21,1309151649),f=g(f,h=g(h,c=g(c,l,f,h,a[d+4],6,-145523070),l,f,a[d+11],10,-1120210379),c,l,a[d+2],15,718787259),h,c,a[d+9],21,-343485551),c=c+m>>>0,l=l+b>>>0,f=f+w>>>0,h=h+x>>>0}return t.endian([c,l,f,h])};i._ff=function(e,t,r,n,o,i,u){var a=e+(t&r|~t&n)+(o>>>0)+u;return(a<<i|a>>>32-i)+t},i._gg=function(e,t,r,n,o,i,u){var a=e+(t&n|r&~n)+(o>>>0)+u;return(a<<i|a>>>32-i)+t},i._hh=function(e,t,r,n,o,i,u){var a=e+(t^r^n)+(o>>>0)+u;return(a<<i|a>>>32-i)+t},i._ii=function(e,t,r,n,o,i,u){var a=e+(r^(t|~n))+(o>>>0)+u;return(a<<i|a>>>32-i)+t},i._blocksize=16,i._digestsize=16,e.exports=function(e,r){if(void 0===e||null===e)throw new Error("Illegal argument "+e);var n=t.wordsToBytes(i(e,r));return r&&r.asBytes?n:r&&r.asString?o.bytesToString(n):t.bytesToHex(n)}}()}),j={genSign:s,getHeaderSign:a,getPolicyAndAuthorization:c,getPurgeHeaderSign:l},C=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},T=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),B=function(){function e(e,t){var r=[],n=!0,o=!1,i=void 0;try{for(var u,a=e[Symbol.iterator]();!(n=(u=a.next()).done)&&(r.push(u.value),!t||r.length!==t);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(o)throw i}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),E=function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";C(this,e),this.bucketName=t,this.serviceName=this.bucketName,this.operatorName=r,this.password=P(n)};return{Client:function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(C(this,t),void 0===e.serviceName)throw new Error("upyun - must config serviceName");if("function"==typeof r&&(n=r,r={}),"function"!=typeof n&&d)throw new Error("upyun - must config a callback function getHeaderSign in client side");if(!d&&(void 0===e.operatorName||void 0===e.password))throw new Error("upyun - must config operateName and password in server side");var o=Object.assign({domain:"v0.api.upyun.com",protocol:"https"},r);this.endpoint=o.protocol+"://"+o.domain,this.req=v(this.endpoint,e,n||h),this.bucket=e,this.service=e,d||this.setBodySignCallback(j.getPolicyAndAuthorization)}return T(t,[{key:"setService",value:function(e){this.service=e,this.req.defaults.baseURL=this.endpoint+"/"+e.serviceName}},{key:"setBucket",value:function(e){return this.setService(e)}},{key:"setBodySignCallback",value:function(e){if("function"!=typeof e)throw new Error("upyun - getBodySign should be a function");this.bodySignCallback=e}},{key:"usage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/";return this.req.get(e+"?usage").then(function(e){var t=e.data;return Promise.resolve(t)})}},{key:"listDir",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.limit,n=void 0===r?100:r,o=t.order,i=void 0===o?"asc":o,u=t.iter,a=void 0===u?"":u,s={};return 100!==n&&(s["x-list-limit"]=n),"asc"!==i&&(s["x-list-order"]=i),a&&(s["x-list-iter"]=a),this.req.get(e,{headers:s}).then(function(e){var t=e.data,r=e.headers;if(404===e.status)return!1;var n=r["x-upyun-list-iter"];if(!t)return Promise.resolve({files:[],next:n});var o=t.split("\n").map(function(e){var t=e.split("\t"),r=B(t,4),n=r[0],o=r[1],i=r[2],u=r[3];return{name:n,type:o,size:parseInt(i),time:parseInt(u)}});return Promise.resolve({files:o,next:n})})}},{key:"putFile",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={};return["Content-MD5","Content-Length","Content-Type","Content-Secret","x-gmkerl-thumb"].forEach(function(e){var t=e.toLowerCase(),o=r[e]||r[t];o?n[e]=o:f(e)&&(n[e]=r[e])}),this.req.put(e,t,{headers:n}).then(function(e){var t=e.headers;if(200!==e.status)return Promise.resolve(!1);var r={};return["x-upyun-width","x-upyun-height","x-upyun-file-type","x-upyun-frames"].forEach(function(e){var n=e.split("x-upyun-")[1];t[e]&&(r[n]=t[e],"file-type"!==n&&(r[n]=parseInt(r[n],10)))}),Promise.resolve(!(Object.keys(r).length>0)||r)})}},{key:"makeDir",value:function(e){return this.req.post(e,null,{headers:{folder:"true"}}).then(function(e){var t=e.status;return Promise.resolve(200===t)})}},{key:"headFile",value:function(e){return this.req.head(e).then(function(e){var t=e.headers;if(404===e.status)return Promise.resolve(!1);var r={};return["x-upyun-file-type","x-upyun-file-size","x-upyun-file-date","Content-Md5"].forEach(function(e){var n=e.split("x-upyun-file-")[1];t[e]&&(r[n]=t[e],"size"!==n&&"date"!==n||(r[n]=parseInt(r[n],10)))}),Promise.resolve(r)})}},{key:"deleteFile",value:function(e){var t={};return arguments.length>1&&void 0!==arguments[1]&&arguments[1]&&(t["x-upyun-async"]=!0),this.req.delete(e,{headers:t}).then(function(e){var t=e.status;return Promise.resolve(200===t)})}},{key:"deleteDir",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.deleteFile.apply(this,t)}},{key:"getFile",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(t&&d)throw new Error("upyun - save as stream are only available on the server side.");return this.req({method:"GET",url:e,responseType:t?"stream":null}).then(function(e){if(404===e.status)return Promise.resolve(!1);if(!t)return Promise.resolve(e.data);var r=e.data.pipe(t);return new Promise(function(e,t){r.on("finish",function(){return e(r)}),r.on("error",t)})})}},{key:"updateMetadata",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"merge",n={};for(var o in t)f(o)?n[o]=t:n["x-upyun-meta-"+o]=t[o];return this.req.patch(e+"?metadata="+r,null,{headers:n}).then(function(e){var t=e.status;return Promise.resolve(200===t)})}},{key:"getMetadata",value:function(e){return this.req.get(e).then(function(e){var t=e.headers;if(200!==e.status)return Promise.resolve(!1);var r={};for(var n in t)f(n)&&(r[n]=t[n]);return Promise.resolve(r)})}},{key:"blockUpload",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=void 0,i=void 0;return d?(o=Promise.resolve(t.size),i=t.type):(o=y.getFileSizeAsync(t),i=y.getContentType(t)),o.then(function(o){Object.assign(n,{"x-upyun-multi-stage":"initiate","x-upyun-multi-length":o,"x-upyun-multi-type":i});var u=Math.ceil(o/1048576);return r.req.put(e,null,{headers:n}).then(function(n){for(var i=n.headers,a=i["x-upyun-multi-uuid"],s=i["x-upyun-next-part-id"],c=Promise.resolve(s),l=0;l<u;l++)c=c.then(function(n){var i=1048576*n,u=Math.min(i+1048576,o);return y.readBlockAsync(t,i,u).then(function(t){return r.req.put(e,t,{headers:{"x-upyun-multi-stage":"upload","x-upyun-multi-uuid":a,"x-upyun-part-id":n}}).then(function(e){var t=e.headers;return n=t["x-upyun-next-part-id"],Promise.resolve(n)})})});return c.then(function(){return r.req.put(e,null,{headers:{"x-upyun-multi-stage":"complete","x-upyun-multi-uuid":a}}).then(function(e){var t=e.status;return Promise.resolve(204===t||201===t)})})})})}},{key:"formPutFile",value:function(e,t){var n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("function"!=typeof this.bodySignCallback)throw new Error("upyun - must setBodySignCallback first!");o.service=this.service.serviceName,o["save-key"]=e;var i=this.bodySignCallback(this.service,o);return"function"!=typeof i.then&&(i=Promise.resolve(i)),i.then(function(e){return r(n.endpoint+"/"+o.service,t,e).then(function(e){return Promise.resolve(e)})})}},{key:"purge",value:function(t){"string"==typeof t&&(t=[t]);var r=j.getPurgeHeaderSign(this.service,t);return e.post("http://purge.upyun.com/purge/","purge="+t.join("\n"),{headers:r}).then(function(e){var t=e.data;if(0===Object.keys(t.invalid_domain_of_url).length)return!0;throw new Error("some url purge failed "+t.invalid_domain_of_url.join(" "))},function(e){throw new Error("upyun - request failed: "+e.message)})}}]),t}(),sign:j,Bucket:E,Service:E}});